---
- name: Configure Aerospace CFD Workstation
  hosts: all
  become: yes
  vars:
    desktop_password: "aerospace-student"
    dcv_url: "https://d1uj6qtbmh3dt5.cloudfront.net/nice-dcv-ubuntu2204-x86_64.tgz"

  tasks:
    # ----------------------------------------------------------------
    # 1. NETWORK & FIREWALL (The Redirect Fix)
    # ----------------------------------------------------------------
    - name: Disable UFW entirely
      service:
        name: ufw
        state: stopped
        enabled: no

    - name: Flush existing iptables rules
      command: iptables -F

    - name: Flush NAT table
      command: iptables -t nat -F

    # CRITICAL FIX: Redirect Port 443 (HTTPS) -> 8443 (DCV)
    # This allows you to connect via https://IP without specifying a port
    - name: Forward Port 443 to 8443
      command: iptables -t nat -A PREROUTING -p tcp --dport 443 -j REDIRECT --to-port 8443

    # ----------------------------------------------------------------
    # 2. MOUNT STORAGE
    # ----------------------------------------------------------------
    - name: Create data directory
      file:
        path: /data
        state: directory
        mode: '0777'

    - name: Format volume
      filesystem:
        fstype: ext4
        dev: /dev/nvme1n1
      ignore_errors: yes

    - name: Mount volume
      mount:
        path: /data
        src: /dev/nvme1n1
        fstype: ext4
        state: mounted

    # ----------------------------------------------------------------
    # 3. INSTALL DESKTOP
    # ----------------------------------------------------------------
    - name: Update apt cache
      apt:
        update_cache: yes
      retries: 5
      delay: 10

    - name: Install Desktop, Fake Monitor, and LightDM
      apt:
        name:
          - xfce4
          - xfce4-goodies
          - xorg
          - dbus-x11
          - x11-xserver-utils
          - xserver-xorg-video-dummy
          - lightdm
        state: present

    - name: Create Xorg config for Fake Monitor
      copy:
        dest: /etc/X11/xorg.conf
        content: |
          Section "Device"
              Identifier  "Configured Video Device"
              Driver      "dummy"
              VideoRam    256000
          EndSection

          Section "Monitor"
              Identifier  "Configured Monitor"
              HorizSync 31.5-48.5
              VertRefresh 50-70
          EndSection

          Section "Screen"
              Identifier  "Default Screen"
              Monitor     "Configured Monitor"
              Device      "Configured Video Device"
              DefaultDepth 24
              SubSection "Display"
              Depth 24
              Modes "1920x1080"
              EndSubSection
          EndSection

    - name: Ensure LightDM is default
      shell: |
        echo "/usr/sbin/lightdm" > /etc/X11/default-display-manager
        dpkg-reconfigure -f noninteractive lightdm

    # ----------------------------------------------------------------
    # 4. OPENFOAM
    # ----------------------------------------------------------------
    - name: Add OpenFOAM Repo
      shell: wget -q -O - https://dl.openfoam.com/add-debian-repo.sh | bash
      args:
        creates: /etc/apt/sources.list.d/openfoam.list

    - name: Install OpenFOAM
      apt:
        name: openfoam2312-default
        state: present

    - name: Add to bashrc
      lineinfile:
        path: /home/ubuntu/.bashrc
        line: "source /usr/lib/openfoam/openfoam2312/etc/bashrc"
        create: yes

    # ----------------------------------------------------------------
    # 5. NICE DCV SETUP
    # ----------------------------------------------------------------
    - name: Create DCV folder
      file:
        path: /tmp/dcv
        state: directory

    - name: Download DCV
      unarchive:
        src: "{{ dcv_url }}"
        dest: /tmp/dcv
        remote_src: yes
        extra_opts: [--strip-components=1]

    - name: Install DCV Server
      shell: apt install -y /tmp/dcv/nice-dcv-server_*.deb

    - name: Install DCV Web Viewer
      shell: apt install -y /tmp/dcv/nice-dcv-web-viewer_*.deb

    # We removed the failed config editing task here.
    # We rely on the iptables redirect instead.

    # ----------------------------------------------------------------
    # 6. USER & PASSWORD
    # ----------------------------------------------------------------
    - name: Set Password
      user:
        name: ubuntu
        password: "{{ desktop_password_hash }}"
        shell: /bin/bash

    - name: Create Simulation Folder
      file:
        path: /home/ubuntu/Desktop/Simulation_Runs
        state: directory
        owner: ubuntu
        group: ubuntu

    # ----------------------------------------------------------------
    # 7. STARTUP SEQUENCE
    # ----------------------------------------------------------------
    - name: Restart Display Manager
      service:
        name: lightdm
        state: restarted

    - name: Wait for X11
      pause:
        seconds: 10

    - name: Enable and Restart DCV
      service:
        name: dcvserver
        enabled: yes
        state: restarted

    - name: Create DCV Session
      shell: dcv create-session --type console --owner ubuntu console
      register: dcv_session
      failed_when:
        - dcv_session.rc != 0
        - "'already exists' not in dcv_session.stderr"
      ignore_errors: yes

    # ----------------------------------------------------------------
    # 8. DEBUGGING
    # ----------------------------------------------------------------
    - name: Check Port 8443 (Where server listens)
      shell: ss -tulpn | grep 8443
      register: port_8443_check
      ignore_errors: yes

    - name: Check NAT Table (Where forwarding happens)
      shell: iptables -t nat -L -n -v | grep 8443
      register: nat_check
      ignore_errors: yes

    - name: PRINT PORT & NAT STATUS
      debug:
        msg:
          - "Server Listener: {{ port_8443_check.stdout }}"
          - "Forwarding Rule: {{ nat_check.stdout }}"