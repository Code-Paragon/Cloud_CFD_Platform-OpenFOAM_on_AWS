name: Aerospace Workstation Manager

on:
  workflow_dispatch:
    inputs:
      action_type:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy   # Creates a new workstation
          - pause    # TERMINATES the workstation but keeps storage safe
          - destroy  # Deletes EVERYTHING (Data is lost)

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_REGION: "us-east-1"
  TF_VAR_aws_region: "us-east-1"
  TF_VAR_key_name: "aerospace-key"

jobs:
  manage-infrastructure:
    name: Execute ${{ inputs.action_type }}
    runs-on: ubuntu-latest

    steps:
      # 1. SETUP
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_wrapper: false

      - name: Create SSH Key File
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Bootstrap State Bucket
        id: bootstrap
        run: |
          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          BUCKET_NAME="aerospace-cfd-state-${OWNER}"
          
          if aws s3api head-bucket --bucket "$BUCKET_NAME" 2>/dev/null; then
            echo "âœ… Bucket exists."
          else
            echo "âš ï¸ Creating bucket..."
            aws s3 mb s3://$BUCKET_NAME --region us-east-1
            aws s3api put-bucket-versioning --bucket $BUCKET_NAME --versioning-configuration Status=Enabled
          fi
          echo "STATE_BUCKET=$BUCKET_NAME" >> $GITHUB_ENV

      - name: Initialize Terraform
        run: |
          terraform init -backend-config="bucket=${{ env.STATE_BUCKET }}"

      # ----------------------------------------------------------------
      # ACTION: PAUSE (Actually Terminates Spot, Keeps Data)
      # ----------------------------------------------------------------
      - name: Pause Workstation
        if: ${{ inputs.action_type == 'pause' }}
        run: |
          # For Spot Instances, "Stopping" isn't allowed. We must Terminate.
          # But since we have a Persistent Data Volume, this is safe!
          echo "âš ï¸ Spot Instances cannot be stopped. Terminating instance (Data volume will be preserved)..."
          terraform destroy -target=aws_instance.cfd_workstation -auto-approve
          echo "âœ… Workstation terminated. Storage volume is SAFE and waiting for next deploy."

      # ----------------------------------------------------------------
      # ACTION: DESTROY
      # ----------------------------------------------------------------
      - name: Destroy Workstation
        if: ${{ inputs.action_type == 'destroy' }}
        run: |
          terraform destroy -auto-approve
          echo "ðŸ—‘ï¸ Infrastructure deleted."

      # ----------------------------------------------------------------
      # ACTION: DEPLOY
      # ----------------------------------------------------------------
      - name: Apply Infrastructure
        if: ${{ inputs.action_type == 'deploy' }}
        run: terraform apply -auto-approve

      # --- REMOVED "Ensure Instance is Running" STEP HERE ---
      # Terraform Apply automatically starts the new instance, so we don't need it.

      - name: Get Connection Details
        if: ${{ inputs.action_type == 'deploy' }}
        id: get_ip
        run: |
          IP=$(terraform output -raw workstation_public_ip)
          echo "INSTANCE_IP=$IP" >> $GITHUB_ENV
          echo "::notice::ðŸš€ Workstation IP: $IP"

      # 4. CONFIGURE SOFTWARE (Ansible)
      - name: Wait for SSH
        if: ${{ inputs.action_type == 'deploy' }}
        run: |
          echo "Waiting for SSH on ${{ env.INSTANCE_IP }}..."
          timeout 300 bash -c 'until nc -z -v -w5 ${{ env.INSTANCE_IP }} 22; do sleep 5; done'

      - name: Install Ansible Dependencies
        if: ${{ inputs.action_type == 'deploy' }}
        run: pip3 install passlib

      - name: Run Ansible
        if: ${{ inputs.action_type == 'deploy' }}
        run: |
          ansible-playbook -i "${{ env.INSTANCE_IP }}," \
            --user ubuntu \
            --private-key key.pem \
            --ssh-common-args='-o StrictHostKeyChecking=no' \
            playbook.yml