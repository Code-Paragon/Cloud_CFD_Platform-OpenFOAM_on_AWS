name: Aerospace Workstation Manager

on:
  workflow_dispatch:
    inputs:
      action_type:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy   # Creates or Resumes
          - pause    # Stops instance (Saves money)
          - destroy  # Deletes everything
      instance_type:
        description: 'Hardware Power'
        required: true
        default: 'c5.2xlarge'
        type: choice
        options:
          - c5.2xlarge   # CPU Only (No waiting for AWS limits!)
          - g4dn.xlarge  # GPU (Requires AWS Quota Approval)

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_REGION: "us-east-1"
  TF_VAR_aws_region: "us-east-1"
  # This MUST match the name of the Key Pair you created in AWS Console!
  TF_VAR_key_name: "aerospace-key"
  TF_VAR_instance_type: ${{ inputs.instance_type }}

jobs:
  manage-infrastructure:
    name: Execute ${{ inputs.action_type }}
    runs-on: ubuntu-latest

    steps:
      # 1. SETUP
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_wrapper: false

      - name: Create SSH Key File
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > key.pem
          chmod 600 key.pem

      # 2. BOOTSTRAP S3 BUCKET (The "Magic" Step)
      # This checks if the bucket exists. If not, it creates it using AWS CLI.
      - name: Bootstrap State Bucket
        id: bootstrap
        run: |
          # Create a unique name using the repo owner's name to avoid conflicts
          # Lowercase is required for S3
          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          BUCKET_NAME="aerospace-cfd-state-${OWNER}"
          
          echo "Target Bucket: $BUCKET_NAME"
          
          # Check if bucket exists (head-bucket returns 0 if yes, 404 if no)
          if aws s3api head-bucket --bucket "$BUCKET_NAME" 2>/dev/null; then
            echo "âœ… Bucket already exists."
          else
            echo "âš ï¸ Bucket not found. Creating..."
            aws s3 mb s3://$BUCKET_NAME --region us-east-1
            # Enable versioning so we don't lose the state file easily
            aws s3api put-bucket-versioning --bucket $BUCKET_NAME --versioning-configuration Status=Enabled
            echo "âœ… Bucket created."
          fi
          
          # Save the name so the next step can use it
          echo "STATE_BUCKET=$BUCKET_NAME" >> $GITHUB_ENV

      # 3. TERRAFORM INIT (Using the bucket we just found/created)
      - name: Initialize Terraform
        run: |
          terraform init -backend-config="bucket=${{ env.STATE_BUCKET }}"

      # ----------------------------------------------------------------
      # ACTION: PAUSE
      # ----------------------------------------------------------------
      - name: Pause Workstation
        if: ${{ inputs.action_type == 'pause' }}
        run: |
          INSTANCE_ID=$(terraform output -raw instance_id)
          echo "Stopping Instance: $INSTANCE_ID..."
          aws ec2 stop-instances --instance-ids $INSTANCE_ID --region ${{ env.AWS_REGION }}
          echo "âœ… Workstation paused."

      # ----------------------------------------------------------------
      # ACTION: DESTROY
      # ----------------------------------------------------------------
      - name: Destroy Workstation
        if: ${{ inputs.action_type == 'destroy' }}
        run: |
          terraform destroy -auto-approve
          echo "ðŸ—‘ï¸ Infrastructure deleted."

      # ----------------------------------------------------------------
      # ACTION: DEPLOY (Create OR Resume)
      # ----------------------------------------------------------------
      - name: Apply Infrastructure
        if: ${{ inputs.action_type == 'deploy' }}
        run: terraform apply -auto-approve

      - name: Ensure Instance is Running
        if: ${{ inputs.action_type == 'deploy' }}
        run: |
          INSTANCE_ID=$(terraform output -raw instance_id)
          aws ec2 start-instances --instance-ids $INSTANCE_ID --region ${{ env.AWS_REGION }}

      - name: Get Connection Details
        if: ${{ inputs.action_type == 'deploy' }}
        id: get_ip
        run: |
          IP=$(terraform output -raw workstation_public_ip)
          echo "INSTANCE_IP=$IP" >> $GITHUB_ENV
          echo "::notice::ðŸš€ Workstation IP: $IP"

      # 4. CONFIGURE SOFTWARE (Ansible)
      - name: Wait for SSH
        if: ${{ inputs.action_type == 'deploy' }}
        run: |
          echo "Waiting for SSH on ${{ env.INSTANCE_IP }}..."
          timeout 300 bash -c 'until nc -z -v -w5 ${{ env.INSTANCE_IP }} 22; do sleep 5; done'

      - name: Run Ansible
        if: ${{ inputs.action_type == 'deploy' }}
        run: |
          ansible-playbook -i "${{ env.INSTANCE_IP }}," \
            --user ubuntu \
            --private-key key.pem \
            --ssh-common-args='-o StrictHostKeyChecking=no' \
            playbook.yml